---
title: Event loop
description: JS ç‰¹è‰²ä¹‹ä¸€æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ‰€è°“çš„åŸºäºäº‹ä»¶çš„å¼‚æ­¥æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ
date: 2019-03-07 11:21:00
published: true
cover: ./Leo Roomets.jpeg
coverAuthor: Leo Roomets
coverOriginalUrl: https://unsplash.com
---

"JS ç‰¹è‰²ä¹‹ä¸€æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ‰€è°“çš„åŸºäºäº‹ä»¶çš„å¼‚æ­¥æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ"

---

### JS æ˜¯å•çº¿ç¨‹

All we know, JS æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹ã€å¼±ç±»å‹ã€åŸºäºåŸå‹çš„è„šæœ¬è¯­è¨€ï¼Œæµè§ˆå™¨ä¸Šæœ‰ç€ JS ä¸“å±çš„å¼•æ“ä½œä¸ºå…¶è§£é‡Šå™¨ï¼ŒV8
å¦å¤–ï¼ŒJS æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œä¸ºä½•å¦‚æ­¤è®¾è®¡å‘¢ï¼Ÿå…¶å®åŸå› å¾ˆç®€å•ï¼ŒJS æ˜¯è¢«ç”¨æ¥è®¾è®¡åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œæ”¯æŒæ“ä½œé¡µé¢ dom å…ƒç´ ï¼Œå‡è®¾åŒæ—¶æœ‰å¤šä¸ªè¿›ç¨‹åŒæ—¶å¯¹åŒä¸€ dom å…ƒç´ è¿›è¡Œ crudï¼Œæµè§ˆå™¨å¦‚ä½•æ‰§è¡Œå‘¢ï¼Ÿæ‰€ä»¥è¿™å°±æ˜¯åŸå› 

å¦å¤– JS è™½ç„¶æ˜¯å•çº¿ç¨‹è¿è¡Œï¼Œä½†æ˜¯åœ¨ä¸»çº¿ç¨‹è¿è¡Œä¹‹å¤–è¿˜æ˜¯æœ‰å…¶ä»–çš„ä¾¦å¬çº¿ç¨‹ä½œä¸ºè¾…åŠ©çš„å¦‚äº‹ä»¶è§¦å‘çº¿ç¨‹ã€Http è¯·æ±‚çº¿ç¨‹ç­‰ï¼Œæ‰€ä»¥ JS æ‰€è°“çš„å•çº¿ç¨‹å¹¶ä¸å­¤å•ã€‚æµè§ˆå™¨å†…æ ¸å®ç°å…è®¸å¤šä¸ªçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œè¿™äº›çº¿ç¨‹åœ¨å†…æ ¸åˆ¶æ§ä¸‹ç›¸äº’é…åˆä»¥ä¿æŒåŒæ­¥

é‚£å•çº¿ç¨‹å´èƒ½æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ä¸ºä½•ï¼Ÿä¸»è¦æ˜¯å› ä¸º JS ä¸­å­˜åœ¨äº‹ä»¶å¾ªç¯(Event Loop)å’Œä»»åŠ¡é˜Ÿåˆ—(Task Queue)ä¹Ÿå«äº‹ä»¶é˜Ÿåˆ—

### JS äº‹ä»¶å¾ªç¯

ç±»ä¼¼è¿›å…¥ä¸€ä¸ª while(true)çš„äº‹ä»¶å¾ªç¯ï¼Œç›´åˆ°æ²¡æœ‰äº‹ä»¶è§‚å¯Ÿè€…é€€å‡ºï¼Œæ¯ä¸ªå¼‚æ­¥äº‹ä»¶éƒ½ç”Ÿæˆä¸€ä¸ªäº‹ä»¶è§‚å¯Ÿè€…ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿå°±è°ƒç”¨è¯¥å›è°ƒå‡½æ•°

ä¸€ä¸ªæµè§ˆå™¨ç¯å¢ƒåªèƒ½æœ‰ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œè€Œä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸»è¦åŒ…å« macrotask å’Œ microtask ä¸¤ä¸ªäº‹ä»¶é˜Ÿåˆ—ï¼ˆmacrotask å’Œ microtask æ˜¯å¼‚æ­¥ä»»åŠ¡çš„ä¸¤ç§åˆ†ç±»ï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªä»»åŠ¡æºï¼ˆTask sourceï¼‰ã€‚åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¿…é¡»æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œ

åœ¨æŒ‚èµ·ä»»åŠ¡æ—¶ï¼ŒJS å¼•æ“ä¼šå°†æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§ç±»åˆ«åˆ†åˆ° macrotask å’Œ microtask è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¸­

æ¯ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œåªå¤„ç†ä¸€ä¸ª macrotaskï¼Œå¾…è¯¥ macrotask å®Œæˆåï¼Œæ‰€æœ‰çš„ microtask ä¼šåœ¨åŒä¸€æ¬¡å¾ªç¯ä¸­å¤„ç†ã€‚å¤„ç†è¿™äº› microtask æ—¶ï¼Œè¿˜å¯ä»¥å°†æ›´å¤šçš„ microtask å…¥é˜Ÿï¼Œå®ƒä»¬ä¼šä¸€ä¸€æ‰§è¡Œï¼Œç›´åˆ°æ•´ä¸ª microtask é˜Ÿåˆ—å¤„ç†å®Œåå¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ª macrotask å¼€å¯æ–°ä¸€è½®äº‹ä»¶å¾ªç¯

##### å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰

- æ•´ä½“ä»£ç (script)
- setTimeout
- setInterval
- setImmediateï¼ˆnodeï¼‰
- I/O
- UI rendering
- requestAnimationFrameï¼ˆæµè§ˆå™¨ï¼‰

##### å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰

- process.nextTickï¼ˆnodeï¼‰
- Promise.then catch finally
- Object.observeï¼ˆå·²åºŸå¼ƒï¼‰
- MutationObserverï¼ˆæµè§ˆå™¨ï¼‰

_æ‹¬å·å†…è¡¨ç¤ºæ”¯æŒçš„ç¯å¢ƒ_

##### æ¡ˆä¾‹åˆ†æ

```js
// å…¨å±€scripts macrotask
console.log('macrotask scripts start')

// macrotask
setTimeout(() => {
  Promise.resolve().then(() => console.log('macrotask 1 inner: microtask'))

  console.log('macrotask 1')
}, 0)

// microtask
Promise.resolve().then(() => console.log('microtask 1'))

// microtask
Promise.resolve().then(() => console.log('microtask 2'))

console.log('macrotask scripts end')

// output:

// VM322:1  macrotask scripts start
// VM322:16 macrotask scripts end
// VM322:11 microtask 1
// VM322:14 microtask 2
// VM322:7  macrotask 1
// VM322:5  macrotask 1 inner: microtask
```

é¦–å…ˆè¿›å…¥ **å…¨å±€ scripts macrotask**

- æ‰§è¡Œå½“å‰ macrotask ä¸­æ‰€æœ‰åŒæ­¥ä»£ç 
  - // VM322:1 macrotask scripts start
  - // VM322:16 macrotask scripts end
- æ‰§è¡Œå®Œæ¯•åæŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œ microtask é˜Ÿåˆ—
  - // VM322:11 microtask 1
  - // VM322:14 microtask 2
- å½“å‰ macrotask æ‰§è¡Œå®Œæ¯•æŸ¥æ‰¾å½“å‰ macrotask é˜Ÿåˆ—ï¼Œè‹¥å·²ç»æ¸…ç©ºåˆ™ç»“æŸäº‹ä»¶å¾ªç¯ï¼Œå¦åˆ™å¼€å¯ä¸‹ä¸€è½®å¾ªç¯
- æ–°ä¸€è½®å¾ªç¯æ‰§è¡Œå½“å‰ macrotask ä¸­æ‰€æœ‰åŒæ­¥ä»£ç 
  - // VM322:7 macrotask 1
- æ‰§è¡Œå®Œæ¯•åæŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œ microtask é˜Ÿåˆ—
  - // VM322:5 macrotask 1 inner: microtask
- å½“å‰ macrotask æ‰§è¡Œå®Œæ¯•æŸ¥æ‰¾å½“å‰ macrotask é˜Ÿåˆ—ï¼Œè‹¥å·²ç»æ¸…ç©ºåˆ™ç»“æŸäº‹ä»¶å¾ªç¯ï¼Œå¦åˆ™å¼€å¯ä¸‹ä¸€è½®å¾ªç¯
  - æ‰§è¡Œå®Œæ¯•ç»“æŸå¾ªç¯

##### è¯¯è§£

é¢è¯•è¿‡å¾ˆå¤šäººå‘ç°ä»–ä»¬åœ¨å›ç­”ç›¸å…³é—®é¢˜æ—¶æ€»ä¼šæœ‰å„ç§è¯¯è§£ï¼šâ€œPromise æ˜¯å¾®ä»»åŠ¡ï¼Œè§£ææ‰§è¡Œä»£ç æ—¶é‡åˆ° promise ä¼šå°†å…¶æ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ç­‰â€

- ä¸€äº›äººè¯´ Promise æ˜¯å¾®ä»»åŠ¡ï¼Œå…¶å® Promsie åªæ˜¯æ™®é€šçš„æ„é€ å‡½æ•°çš„åˆå§‹åŒ–ï¼Œ.then ç­‰é’©å­æ‰æ˜¯å¾®ä»»åŠ¡ï¼Œè§¦å‘.then çš„æ—¶å€™æ‰ä¼šå°†.then çš„å›è°ƒæ¨å…¥ä»»åŠ¡é˜Ÿåˆ—
- é”®ç›˜äº‹ä»¶ç”± webcore çš„ DOM Binding æ¨¡å—æ¥å¤„ç†ï¼Œå½“äº‹ä»¶è§¦å‘æ—¶å°†ç›‘å¬äº‹ä»¶çš„å›è°ƒå‡½æ•°æ¨å…¥ä»»åŠ¡é˜Ÿåˆ—
- setTimeout ç”± webcore çš„ timer æ¨¡å—æ¥è¿›è¡Œå»¶æ—¶å¤„ç†ï¼Œå½“æ—¶é—´åˆ°è¾¾çš„æ—¶å€™ï¼Œæ‰ä¼šå°†å›è°ƒå‡½æ•°æ¨å…¥ä»»åŠ¡é˜Ÿ
- ajax åˆ™ä¼šç”± webcore çš„ network æ¨¡å—æ¥å¤„ç†ï¼Œåœ¨ç½‘ç»œè¯·æ±‚å®Œæˆè¿”å›ä¹‹åï¼Œæ‰ä¼šå°†å›è°ƒå‡½æ•°æ¨å…¥ä»»åŠ¡é˜Ÿ

### Node çš„äº‹ä»¶å¾ªç¯

node æ˜¯ js çš„ä¸€ä¸ª runtimeï¼Œæ‰€ä»¥äº‹ä»¶å¾ªç¯åŒæ ·æ˜¯ Node.js å¤„ç†éé˜»å¡ I/O æ“ä½œçš„æœºåˆ¶ã€‚ç”±äºå¤§å¤šæ•°å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œnode.js ä¼šå°½å¯èƒ½å°†æ“ä½œè£…è½½åˆ°ç³»ç»Ÿå†…æ ¸ã€‚å› æ­¤å®ƒä»¬å¯ä»¥å¤„ç†åœ¨åå°æ‰§è¡Œçš„å¤šä¸ªæ“ä½œã€‚å½“å…¶ä¸­ä¸€ä¸ªæ“ä½œå®Œæˆæ—¶ï¼Œå†…æ ¸ä¼šå‘Šè¯‰ Node.jsï¼Œä»¥ä¾¿ node.js å¯ä»¥å°†ç›¸åº”çš„å›è°ƒæ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—ä¸­ä»¥æœ€ç»ˆæ‰§è¡Œ

å½“ Node.js å¯åŠ¨åï¼Œå®ƒä¼šåˆå§‹åŒ–äº‹ä»¶è½®è¯¢ï¼›å¤„ç†å·²æä¾›çš„è¾“å…¥è„šæœ¬ï¼ˆæˆ–ä¸¢å…¥ REPLï¼‰ï¼Œå®ƒå¯èƒ½ä¼šè°ƒç”¨ä¸€äº›å¼‚æ­¥çš„ API å‡½æ•°è°ƒç”¨ï¼Œå®‰æ’ä»»åŠ¡å¤„ç†äº‹ä»¶ï¼Œæˆ–è€…è°ƒç”¨ process.nextTickï¼Œç„¶åå¼€å§‹å¤„ç†äº‹ä»¶å¾ªç¯

ä¸æµè§ˆå™¨ç«¯çš„äº‹ä»¶å¾ªç¯ç›¸æ¯”æœ‰å¾ˆå¤§ä¸åŒï¼Œnode çš„äº‹ä»¶å¾ªç¯ä¸»è¦åˆ†ä¸ºå…­ä¸ªé˜¶æ®µï¼ˆPhaseï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ä¼šæœ‰ä¸€ä¸ªç±»ä¼¼äºé˜Ÿåˆ—çš„ç»“æ„, å­˜å‚¨ç€è¯¥é˜¶æ®µéœ€è¦å¤„ç†çš„å›è°ƒå‡½æ•°ï¼š

- timerï¼šç”¨ä¸€ä¸ª for å¾ªç¯å¤„ç†æ‰€æœ‰ setTimeout å’Œ setInterval çš„å›è°ƒ
  - æ£€æŸ¥ timer é˜Ÿåˆ—æ˜¯å¦æœ‰åˆ°æœŸçš„ timer å›è°ƒï¼Œå¦‚æœæœ‰ï¼Œå°†åˆ°æœŸçš„ timer å›è°ƒæŒ‰ç…§ timerId å‡åºæ‰§è¡Œ
  - æ£€æŸ¥æ˜¯å¦æœ‰ process.nextTick ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - æ£€æŸ¥æ˜¯å¦æœ‰ microtaskï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - é€€å‡ºè¯¥é˜¶æ®µ
- Pending I/O Callback Phaseï¼šæ‰§è¡Œä½ çš„ fs.read, socket ç­‰ IO æ“ä½œçš„å›è°ƒå‡½æ•°, åŒæ—¶ä¹ŸåŒ…æ‹¬å„ç§ error çš„å›è°ƒ
  - æ£€æŸ¥æ˜¯å¦æœ‰ pending çš„ I/O å›è°ƒã€‚å¦‚æœæœ‰ï¼Œæ‰§è¡Œå›è°ƒã€‚å¦‚æœæ²¡æœ‰ï¼Œé€€å‡ºè¯¥é˜¶æ®µ
  - æ£€æŸ¥æ˜¯å¦æœ‰ process.nextTick ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - æ£€æŸ¥æ˜¯å¦æœ‰ microtaskï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - é€€å‡ºè¯¥é˜¶æ®µ
- idle, prepareï¼šä»…ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨
- Poll Phaseï¼šæ£€ç´¢æ–°çš„ I/O äº‹ä»¶;æ‰§è¡Œä¸ I/O ç›¸å…³çš„å›è°ƒï¼ˆå‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹ï¼Œé™¤äº†å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬ç”±è®¡æ—¶å™¨å’Œ setImmediate æ’å®šçš„ä¹‹å¤–ï¼‰ï¼Œå…¶ä½™æƒ…å†µ node å°†åœ¨æ­¤å¤„é˜»å¡ï¼Œå¾ªç¯ä¸­æœ€é‡è¦çš„ä¸€ä¸ª Phase, ä½œç”¨æ˜¯ç­‰å¾…å¼‚æ­¥è¯·æ±‚å’Œæ•°æ®ï¼Œæœ€é‡è¦æ˜¯å› ä¸ºå®ƒæ”¯æ’‘äº†æ•´ä¸ªæ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼ŒPoll Phase é¦–å…ˆä¼šæ‰§è¡Œ watch_queue é˜Ÿåˆ—ä¸­çš„ IO è¯·æ±‚, ä¸€æ—¦ watch_queue é˜Ÿåˆ—ç©º, åˆ™æ•´ä¸ªæ¶ˆæ¯å¾ªç¯å°±ä¼šè¿›å…¥ sleep , ä»è€Œç­‰å¾…è¢«å†…æ ¸äº‹ä»¶å”¤é†’
  é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å°šæœªå®Œæˆçš„å›è°ƒï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆåˆ†ä¸¤ç§æƒ…å†µã€‚
  - ç¬¬ä¸€ç§æƒ…å†µï¼š
    - å¦‚æœæœ‰å¯ç”¨å›è°ƒï¼ˆå¯ç”¨å›è°ƒåŒ…å«åˆ°æœŸçš„å®šæ—¶å™¨è¿˜æœ‰ä¸€äº› IO äº‹ä»¶ç­‰ï¼‰ï¼Œæ‰§è¡Œæ‰€æœ‰å¯ç”¨å›è°ƒ
    - æ£€æŸ¥æ˜¯å¦æœ‰ process.nextTick å›è°ƒï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
    - æ£€æŸ¥æ˜¯å¦æœ‰ microtaksï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
    - é€€å‡ºè¯¥é˜¶æ®µ
  - ç¬¬äºŒç§æƒ…å†µï¼š
    - å¦‚æœæ²¡æœ‰å¯ç”¨å›è°ƒ
    - æ£€æŸ¥æ˜¯å¦æœ‰ immediate å›è°ƒï¼Œå¦‚æœæœ‰ï¼Œé€€å‡º poll é˜¶æ®µã€‚å¦‚æœæ²¡æœ‰ï¼Œé˜»å¡åœ¨æ­¤é˜¶æ®µï¼Œç­‰å¾…æ–°çš„äº‹ä»¶é€šçŸ¥
    - å¦‚æœä¸å­˜åœ¨å°šæœªå®Œæˆçš„å›è°ƒï¼Œé€€å‡º poll é˜¶æ®µ
- Check Phaseï¼šè¿™ä¸ªé˜¶æ®µåªå¤„ç† setImmediate çš„å›è°ƒå‡½æ•°ï¼ˆå› ä¸º Poll Phase é˜¶æ®µå¯èƒ½è®¾ç½®ä¸€äº›å›è°ƒ, å¸Œæœ›åœ¨ Poll Phase åè¿è¡Œ. æ‰€ä»¥åœ¨ Poll Phase åé¢å¢åŠ äº†è¿™ä¸ª Check Phase.ï¼‰
  - å¦‚æœæœ‰ immediate å›è°ƒï¼Œåˆ™æ‰§è¡Œæ‰€æœ‰ immediate å›è°ƒ
  - æ£€æŸ¥æ˜¯å¦æœ‰ process.nextTick å›è°ƒï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - æ£€æŸ¥æ˜¯å¦æœ‰ microtaksï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - é€€å‡º check é˜¶æ®µ
- Close Callbacks Phaseï¼šä¸“é—¨å¤„ç†ä¸€äº› close ç±»å‹çš„å›è°ƒ. æ¯”å¦‚ socket.on('close', ...). ç”¨äºèµ„æºæ¸…ç†
  - å¦‚æœæœ‰ immediate å›è°ƒï¼Œåˆ™æ‰§è¡Œæ‰€æœ‰ immediate å›è°ƒ
  - æ£€æŸ¥æ˜¯å¦æœ‰ process.nextTick å›è°ƒï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - æ£€æŸ¥æ˜¯å¦æœ‰ microtaksï¼Œå¦‚æœæœ‰ï¼Œå…¨éƒ¨æ‰§è¡Œ
  - é€€å‡º closing é˜¶æ®µ
    ä¸€è½®å¾ªç¯ç»“æŸåæ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„ handlesï¼ˆå®šæ—¶å™¨ã€IO ç­‰äº‹ä»¶å¥æŸ„ï¼‰å¦‚æœæœ‰å°±ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç»“æŸäº‹ä»¶å¾ªç¯ï¼Œé€€å‡ºç¨‹åº

äº‹ä»¶å¾ªç¯è¿‡ç¨‹å¦‚ä¸‹å›¾ç¤ºæ„*æ¯ä¸ªæ¡†å†…ä»£è¡¨ä¸€ä¸ªé˜¶æ®µ*ï¼š

```js
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ª FIFO é˜Ÿåˆ—æ¥æ‰§è¡Œå›è°ƒã€‚è™½ç„¶æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ç‰¹æ®Šçš„ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“äº‹ä»¶å¾ªç¯è¿›å…¥ç»™å®šçš„é˜¶æ®µæ—¶ï¼Œå®ƒå°†æ‰§è¡Œç‰¹å®šäºè¯¥é˜¶æ®µçš„ä»»ä½•æ“ä½œï¼Œç„¶ååœ¨è¯¥é˜¶æ®µçš„é˜Ÿåˆ—ä¸­æ‰§è¡Œå›è°ƒï¼Œç›´åˆ°é˜Ÿåˆ—ç”¨å°½æˆ–æœ€å¤§å›è°ƒæ•°å·²æ‰§è¡Œã€‚å½“è¯¥é˜Ÿåˆ—å·²ç”¨å°½æˆ–è¾¾åˆ°å›è°ƒé™åˆ¶ï¼Œäº‹ä»¶å¾ªç¯å°†ç§»åŠ¨åˆ°ä¸‹ä¸€é˜¶æ®µ

ç”±äºè¿™äº›æ“ä½œä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½è®¡åˆ’ æ›´å¤šçš„ æ“ä½œï¼Œå¹¶ä¸”åœ¨ è½®è¯¢ é˜¶æ®µå¤„ç†çš„æ–°äº‹ä»¶ç”±å†…æ ¸æ’é˜Ÿï¼Œå› æ­¤åœ¨å¤„ç†è½®è¯¢äº‹ä»¶æ—¶ï¼Œè½®è¯¢äº‹ä»¶å¯ä»¥æ’é˜Ÿã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œå›è°ƒå¯ä»¥å…è®¸è½®è¯¢é˜¶æ®µè¿è¡Œå¤§é‡é•¿äºè®¡æ—¶å™¨çš„é˜ˆå€¼

åœ¨æ¯æ¬¡è¿è¡Œçš„äº‹ä»¶å¾ªç¯ä¹‹é—´ï¼ŒNode.js æ£€æŸ¥å®ƒæ˜¯å¦åœ¨ç­‰å¾…ä»»ä½•å¼‚æ­¥ I/O æˆ–è®¡æ—¶å™¨ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™å…³é—­å¹²å‡€

è¡¥å……ï¼š

1. setImmediate å¯¹æ¯” setTimeout
   setImmediate å’Œ setTimeout å¾ˆç±»ä¼¼ï¼Œä½†ä½•æ—¶è°ƒç”¨è¡Œä¸ºå®Œå…¨ä¸åŒ

- setImmediate è®¾è®¡ä¸ºåœ¨å½“å‰ è½®è¯¢ é˜¶æ®µå®Œæˆåæ‰§è¡Œè„šæœ¬
- setTimeout è®¡åˆ’åœ¨æ¯«ç§’çš„æœ€å°é˜ˆå€¼ç»è¿‡åè¿è¡Œçš„è„šæœ¬
  æ‰§è¡Œè®¡æ—¶å™¨çš„é¡ºåºå°†æ ¹æ®è°ƒç”¨å®ƒä»¬çš„ä¸Šä¸‹æ–‡è€Œå¼‚ã€‚å¦‚æœäºŒè€…éƒ½ä»ä¸»æ¨¡å—å†…è°ƒç”¨ï¼Œåˆ™è®¡æ—¶å°†å—è¿›ç¨‹æ€§èƒ½çš„çº¦æŸï¼ˆè¿™å¯èƒ½ä¼šå—åˆ°è®¡ç®—æœºä¸Šè¿è¡Œçš„å…¶å®ƒåº”ç”¨ç¨‹åºçš„å½±å“ï¼‰

2. process.nextTick
   process.nextTick åœ¨æŠ€æœ¯ä¸Šä¸æ˜¯äº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚ç›¸åï¼Œæ— è®ºäº‹ä»¶å¾ªç¯çš„å½“å‰é˜¶æ®µå¦‚ä½•ï¼Œéƒ½å°†åœ¨å½“å‰æ“ä½œå®Œæˆåå¤„ç† nextTickQueueã€‚è¿™é‡Œçš„ä¸€ä¸ªæ“ä½œè¢«è§†ä½œä¸ºä¸€ä¸ªä» C++ åº•å±‚å¤„ç†å¼€å§‹è¿‡æ¸¡ï¼Œå¹¶ä¸”å¤„ç†éœ€è¦æ‰§è¡Œçš„ JavaScript ä»£ç 
   ä»»ä½•æ—¶å€™åœ¨ç»™å®šçš„é˜¶æ®µä¸­è°ƒç”¨ process.nextTickï¼Œæ‰€æœ‰ä¼ é€’åˆ° process.nextTick çš„å›è°ƒå°†åœ¨äº‹ä»¶å¾ªç¯ç»§ç»­ä¹‹å‰å¾—åˆ°è§£å†³ã€‚è¿™å¯èƒ½ä¼šé€ æˆä¸€äº›ç³Ÿç³•çš„æƒ…å†µ, å› ä¸ºå®ƒå…è®¸æ‚¨é€šè¿‡è¿›è¡Œé€’å½’ process.nextTick æ¥â€œé¥¿æ­»â€æ‚¨çš„ I/O è°ƒç”¨ï¼Œé˜»æ­¢äº‹ä»¶å¾ªç¯åˆ°è¾¾ è½®è¯¢ é˜¶æ®µ

ä»¥ä¸Šç®€è¦ä»‹ç» JS/Node çš„äº‹ä»¶å¾ªç¯ï¼Œå­˜åœ¨ç›¸å…³é”™è¯¯è¯·æŒ‡å‡º ğŸ˜„

Linkï¼š

- [The Node.js Event Loop, Timers, and process.nextTick()](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
- [æ·±å…¥åˆ†æ Node.js äº‹ä»¶å¾ªç¯](https://blog.csdn.net/i10630226/article/details/81369841)

End
