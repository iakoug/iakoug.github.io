{"componentChunkName":"component---src-templates-post-js","path":"/fetch-concurrency/","result":{"data":{"markdownRemark":{"html":"<p>和各类型拦截器封装的本质一样，通过不直接更改原宿主的形式对原宿主进行包装重写覆盖（或者称之为装饰者模式）</p>\n<p><em>代码由 <code class=\"language-text\">wx.request</code> 作为示例</em></p>\n<hr>\n<h3 id=\"从使用开始\" style=\"position:relative;\"><a href=\"#%E4%BB%8E%E4%BD%BF%E7%94%A8%E5%BC%80%E5%A7%8B\" aria-label=\"从使用开始 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>从使用开始</h3>\n<p>先从使用场景入手，希望引入一个函数可以接受原 request 方法以及控制的并发数从而返回一个内部可以控制指定并发数的新请求函数</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request-concurrency'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> new_fetch <span class=\"token operator\">=</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span>fetch<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>所以主要就是处理以下三件事：</p>\n<ol>\n<li>接受原请求方法以及并发数参数</li>\n<li>构建请求派发队列</li>\n<li>对原请求进行包装参数处理</li>\n</ol>\n<h3 id=\"接受原请求方法以及并发数参数\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E5%8F%97%E5%8E%9F%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E4%BB%A5%E5%8F%8A%E5%B9%B6%E5%8F%91%E6%95%B0%E5%8F%82%E6%95%B0\" aria-label=\"接受原请求方法以及并发数参数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接受原请求方法以及并发数参数</h3>\n<p>接受原请求方法以及并发数参数并返回一个 promsie</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 向外暴露的接口方法</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">setConcurrencyRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> concurrency <span class=\"token operator\">=</span> <span class=\"token number\">10</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> request <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request must be function'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 请求队列</span>\n  <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\">// 对外暴露的调用方法</span>\n  <span class=\"token keyword\">return</span> <span class=\"token parameter\">apiArgs</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>接下来需要构建请求派发队列，主要分为两部分：执行队列和等待队列</p>\n<h3 id=\"构建请求派发队列\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E5%BB%BA%E8%AF%B7%E6%B1%82%E6%B4%BE%E5%8F%91%E9%98%9F%E5%88%97\" aria-label=\"构建请求派发队列 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构建请求派发队列</h3>\n<p>用闭包对两个队列分别做存储，用户每次触发客户端请求都会先将请求推入等待队列中，而在执行阶段则主要做两件事情，一是不断将执行队列中的请求派发出去（初始是空），二是不断检查执行队列的长度（并发数），当执行队列的长度在并发数以内则将等待队列中的请求按顺序推入（先入先出）执行队列。</p>\n<p>这里的最重要的地方是执行队列中请求完成的时候返回客户端结果同时将该请求从执行队列中移除。</p>\n<p>也主要有三件事情：</p>\n<ol>\n<li>接受客户端传入的请求推入等待队列 <code class=\"language-text\">push</code></li>\n<li>派发当前执行队列中的请求 <code class=\"language-text\">excute</code></li>\n<li>移除执行队列中结束的请求，将等待队列中相应数量的请求按照先进先出的顺序移除并推入执行队列 <code class=\"language-text\">changeQueue</code></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestQueue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">call<span class=\"token punctuation\">,</span> concurrency</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  concurrency <span class=\"token operator\">=</span> concurrency <span class=\"token operator\">||</span> <span class=\"token number\">5</span>\n\n  <span class=\"token comment\">// 挂起</span>\n  <span class=\"token keyword\">const</span> waitingList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 执行</span>\n  <span class=\"token keyword\">const</span> executionList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> model <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      concurrency<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentRequest<span class=\"token punctuation\">,</span> call</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        waitingList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          currentRequest<span class=\"token punctuation\">,</span>\n          call\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>concurrency <span class=\"token operator\">></span> executionList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> waitingList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 将挂起队列中请求推进执行队列</span>\n          <span class=\"token keyword\">const</span> apiModel <span class=\"token operator\">=</span> waitingList<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          executionList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n          <span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n            apiModel<span class=\"token punctuation\">.</span>currentRequest<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">setCall</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">changeQueue</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                apiModel<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Function <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apiModel</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">}</span>\n\n              <span class=\"token comment\">// 发起请求</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">changeQueue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">apiModel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 从执行队列移除</span>\n        <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> executionList<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          executionList<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> model\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"source-code\" style=\"position:relative;\"><a href=\"#source-code\" aria-label=\"source code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source code</h3>\n<p>源码放在：</p>\n<blockquote>\n<p><a href=\"https://github.com/justwink/request-concurrency/blob/master/lib/index.js\">https://github.com/justwink/request-concurrency/blob/master/lib/index.js</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> defaultConcurrency <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">setConcurrencyCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">concurrency <span class=\"token operator\">=</span> defaultConcurrency</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> concurrency <span class=\"token operator\">&amp;&amp;</span> concurrency<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Number\n    <span class=\"token operator\">?</span> concurrency\n    <span class=\"token operator\">:</span> defaultConcurrency\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 回调结束置空</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setCall</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">fn</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'repeating call has been denied.'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> call <span class=\"token operator\">=</span> fn\n  fn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getRequestQueue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">call<span class=\"token punctuation\">,</span> concurrency</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  concurrency <span class=\"token operator\">=</span> <span class=\"token function\">setConcurrencyCount</span><span class=\"token punctuation\">(</span>concurrency<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 挂起</span>\n  <span class=\"token keyword\">const</span> waitingList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 执行</span>\n  <span class=\"token keyword\">const</span> executionList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> model <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      concurrency<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentRequest<span class=\"token punctuation\">,</span> call</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        waitingList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          currentRequest<span class=\"token punctuation\">,</span>\n          call\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n      <span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>concurrency <span class=\"token operator\">></span> executionList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> waitingList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 将挂起队列中请求推进执行队列</span>\n          <span class=\"token keyword\">const</span> apiModel <span class=\"token operator\">=</span> waitingList<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n          executionList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n\n          <span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n            apiModel<span class=\"token punctuation\">.</span>currentRequest<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">setCall</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">changeQueue</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                apiModel<span class=\"token punctuation\">.</span>call<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Function <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apiModel</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">}</span>\n\n              <span class=\"token comment\">// 发起请求</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">excute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n      <span class=\"token function\">changeQueue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">apiModel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 从执行队列移除</span>\n        <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> executionList<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>apiModel<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          executionList<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> model\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">setConcurrencyRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> concurrency <span class=\"token operator\">=</span> defaultConcurrency</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> request <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request must be function'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> <span class=\"token function\">getRequestQueue</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">currentRequest<span class=\"token punctuation\">,</span> call</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">currentRequest</span><span class=\"token punctuation\">(</span>call<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    concurrency\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token parameter\">apiArgs</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">call</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> complete <span class=\"token operator\">=</span> apiArgs<span class=\"token punctuation\">.</span>complete\n\n        apiArgs<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">complete</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 请求完成</span>\n          <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>complete<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            complete<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Function <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">complete</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>apiArgs<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>apiArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> setConcurrencyRequest</code></pre></div>","timeToRead":3,"excerpt":"和各类型拦截器封装的本质一样，通过不直接更改原宿主的形式对原宿主进行包装重写覆盖（或者称之为装饰者模式） 代码由  作为示例 从使用开始 先从使用场景入手，希望引入一个函数可以接受原 request…","frontmatter":{"title":"Fetch concurrency - 封装一个请求并发控制的库","thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y5VUbUhTURg+26JfQb8F9Z5t9+7jujk/tmuZaGppGWZ+pGSoGKalpaLO/P6MpWJUgoFR9LNCsgwUpSxLMW2bUwkxzZWa5QdpJlpkcTvnuPzXpgcuz3uel/vwPO859wJgZ31McgefMlhSf6tlRBh/3Ja6rTVKl1au0gl4v3pdKlw2MGBbazJWQ/BrhVyIcaVO6rTeRE/z92T86g26G3N/HkgESNyx2Ii3FjwGQWAuV7nFzeXJe5HTXz8bGH7ZQLdj7ns9LUC1Y0GzmNt0GedOok6dURtm0lT850zl7EYJy8/lMhmYn9czImu03L6YCfoQHAvxJFHHIz11E1Eev63xmomFVA0/c041vVik2IN7sxdZgV2xHugP+ig/MCTWgrlmNeGG3bUDo8Fei+MRngtTcZ689ZQmFvMfTm+6Xyiwcygv4CGbS05ki540AvfxFlY3PObF8SMe2vlBRueEexaFTjCvl9mP2wGPAROlI/UbSisyQp9JJD5jorgvE9CXN1PcXdwzUpzA7MwBNFfHB9ILA4i7Xiog0Sz25weo/SYLcmmE3JJJwrmRBBQndCjUIM0ET+ER0EMdJIPugiF9aAQLaG99Kwnk+6FvJ+b7oJ+w3/UAsMh0/xerleWBGpketMHjROwJPCFvg+EbHTBs8BkMXTdJjvKvYCC5Ki9hsMg2Z8dxm8VxuzC2wJh09Ky3iiOH++hYHs12qIsKJUKdMAwYHYlhd3XIZatrFJnNLcnZO/dhvPUhPLn0CEZbW8Qx7KbzSNJ/Tfk6dlfL5Als6FLD6C03JemDTZLU99forCzMj7q4C5w178BzeBjFDrIvls9WgTJlCREsVZYylYqi7kpF8Vq1vHD1iizfA/OV8mIhj7Adhjt2hwWRCKmL2HKPYra8FAmnVCsKyWdQpSgkvUZpxvZ+VXImGeSo64jDbFWNU7bKIP7Xuyy/tPW91jM5YNsrwa2KvJimrvM+r67di+sSZRk5hAuaGiRcAAxM/jYdypIJqmQpu30VmeTGRij1hCtgKwAaAdjRwpFt6CSlE8ncaCZJgOLvSOcvuDsP7YSsLpgAAAAASUVORK5CYII=","width":150,"height":150,"src":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png","srcSet":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png 1x"}}},"slug":"fetch-concurrency","date":"2019-06-13T00:00:00.000Z","categories":["Encapsulating"],"tags":["fetch"],"template":"post"},"fields":{"slug":"/fetch-concurrency/","date":"2019-06-13T00:00:00.000Z"}}},"pageContext":{"slug":"/fetch-concurrency/"}}}