{"componentChunkName":"component---src-templates-post-js","path":"/fiber-reconciler/","result":{"data":{"markdownRemark":{"html":"<p>最近的 Group sharing 提到了 React16 中新引入的 Fiber reconciler 算法（区分之前的 Stack reconciler），深入浅出的梳理一番。</p>\n<hr>\n<h3 id=\"问题\" style=\"position:relative;\"><a href=\"#%E9%97%AE%E9%A2%98\" aria-label=\"问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题</h3>\n<p>大量的同步计算任务阻塞了浏览器的 UI 渲染。默认情况下，JS 运算、页面布局和页面绘制都是互斥的运行在浏览器的主线程当中。如果 JS 运算持续占用主线程，页面就没法得到及时的更新。当我们调用 setState 更新页面的时候，React 会遍历应用的所有节点，计算出差异，然后再更新 UI。整个过程是一气呵成，不能被打断的。如果页面元素很多，整个过程占用的时机就可能超过 16 毫秒，就容易出现掉帧的现象。</p>\n<p>针对这一问题，React 团队从框架层面对 web 页面的运行机制做了优化，得到很好的效果。</p>\n<p><img src=\"https://i.loli.net/2020/03/29/3akQRFy8WsXhSZi.png\" alt=\"stack\"></p>\n<h3 id=\"方案\" style=\"position:relative;\"><a href=\"#%E6%96%B9%E6%A1%88\" aria-label=\"方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>方案</h3>\n<p>解决主线程长时间被 JS 运算占用这一问题的基本思路，是将运算切割为多个步骤，分批完成。也就是说在完成一部分任务之后，将控制权交回给浏览器，让浏览器有时间进行页面的渲染。等浏览器忙完之后，再继续之前未完成的任务。</p>\n<p>旧版 React 通过递归的方式进行渲染，使用的是 JS 引擎自身的函数调用栈，它会一直执行到栈空为止。而 Fiber 实现了自己的组件调用栈，它以链表的形式遍历组件树，可以灵活的暂停、继续和丢弃执行的任务。实现方式是使用了浏览器的 requestIdleCallback 这一 API。官方的解释是这样的：</p>\n<p>window.requestIdleCallback()会在浏览器空闲时期依次调用函数，这就可以让开发者在主事件循环中执行后台或低优先级的任务，而且不会对像动画和用户交互这些延迟触发但关键的事件产生影响。函数一般会按先进先调用的顺序执行，除非函数在浏览器调用它之前就到了它的超时时间。</p>\n<p><img src=\"https://i.loli.net/2020/03/29/KTVjUfLNOwuSGpX.png\" alt=\"frame\"></p>\n<h3 id=\"实现\" style=\"position:relative;\"><a href=\"#%E5%AE%9E%E7%8E%B0\" aria-label=\"实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>实现</h3>\n<p>原本的实现机制中 React 内部会将 JSX 转化为 AST node，而在这个过程中将引入一个生成 Fiber node 的阶段，建立一条由节点、类型、标记等信息的一个 Fiber node 组成的链表结构。</p>\n<p><img src=\"https://i.loli.net/2020/03/29/aBOMNU8njZAbs7K.png\" alt=\"fiber\"></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Fiber</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tag<span class=\"token punctuation\">,</span> vnode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token comment\">// 标记</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tag <span class=\"token operator\">=</span> tag\n    <span class=\"token comment\">// 类型</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oldProps <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token comment\">// 副作用</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token comment\">// 另一个节点</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token comment\">// 携带下一个props</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> vnode\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oldChildren <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>构建节点信息的同时要确保过程是可以打断的，链表的根节点信息需要进行初始化。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">FiberRoot</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dom<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 当前开始的节点</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token comment\">// 过期时间</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> dom <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>done <span class=\"token operator\">=</span> cb <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>构建的链表结构所对应的 CRUD 行为进行定义。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heap<span class=\"token punctuation\">,</span> node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> i <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">.</span>length\n  heap<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">siftUp</span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heap</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> first <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>first<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!==</span> first<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    heap<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> last\n    <span class=\"token function\">siftDown</span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">,</span> last<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> first\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">siftUp</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heap<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> pi <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>>></span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">const</span> parent <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">[</span>pi<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    heap<span class=\"token punctuation\">[</span>pi<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node\n    heap<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> parent\n    i <span class=\"token operator\">=</span> pi\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">siftDown</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heap<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> li <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">const</span> left <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">[</span>li<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>li <span class=\"token operator\">>=</span> heap<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    <span class=\"token keyword\">const</span> ri <span class=\"token operator\">=</span> li <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">const</span> right <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">[</span>ri<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> ci <span class=\"token operator\">=</span> ri <span class=\"token operator\">&lt;</span> heap<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span>right<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> ri <span class=\"token operator\">:</span> li\n    <span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">[</span>ci<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    heap<span class=\"token punctuation\">[</span>ci<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node\n    heap<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> child\n    i <span class=\"token operator\">=</span> ci\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">-</span> b<span class=\"token punctuation\">.</span>expirationTime\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 模拟使用首项</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heap</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> heap<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此时需要一些全局变量记录工作状态。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 任务队列</span>\n<span class=\"token keyword\">const</span> taskQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\">// 当前正在执行的任务回调</span>\n<span class=\"token keyword\">let</span> currentCallback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token comment\">// 当前任务</span>\n<span class=\"token keyword\">let</span> currentTask <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token comment\">// 一帧间隔 自定义为5ms</span>\n<span class=\"token keyword\">let</span> frameLength <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n<span class=\"token comment\">// 一帧间隔内过期时间</span>\n<span class=\"token keyword\">let</span> frameDeadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token comment\">// 正在工作状态</span>\n<span class=\"token keyword\">let</span> isPerformingWork <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></code></pre></div>\n<p>定义操作类型。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">HOST</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">HOOKCOMPONENT</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CLASSCOMPONENT</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">HOSTROOT</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>NormalPriority<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">97</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">NOWORK</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DELETE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">UPDATE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PLACEMENT</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>在调用 React 的 render 周期函数时，开始进行 Fiber node 的生成调度工作。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 当前正在执行的工作</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">WIP</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token comment\">// 待提交队列</span>\n<span class=\"token keyword\">let</span> commitQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> preCommit <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token comment\">// 当前时间过期判断终止生成动作</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> frameDeadline\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">performWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">didout <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 构建fiber树</span>\n\n  <span class=\"token constant\">WIP</span> <span class=\"token operator\">=</span> rootFiber<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\">// shouldYield 当前时间过期判断终止生成动作</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">WIP</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> didout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 更新当前状态</span>\n    <span class=\"token constant\">WIP</span> <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WIP</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>didout <span class=\"token operator\">&amp;&amp;</span> <span class=\"token constant\">WIP</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    rootFiber<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">WIP</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token function\">performWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>preCommit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 下面定义提交动作</span>\n    <span class=\"token comment\">// commitWork(preCommit, commitQueue)</span>\n  <span class=\"token punctuation\">}</span>\n\n  commitQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  preCommit <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  rootFiber<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> fiber\n\n  <span class=\"token keyword\">const</span> startTime <span class=\"token operator\">=</span> <span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> timeout <span class=\"token operator\">=</span> <span class=\"token number\">5000</span>\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> startTime <span class=\"token operator\">+</span> timeout\n\n  <span class=\"token keyword\">const</span> newTask <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n    startTime<span class=\"token punctuation\">,</span>\n    callback<span class=\"token operator\">:</span> performWorkOnRoot\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">,</span> newTask<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">requestHostCallback</span><span class=\"token punctuation\">(</span>flushWork<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>定义提交动作。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">,</span> patchQueue</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 提交阶段</span>\n  patchQueue<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> <span class=\"token function\">commit</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  fiber<span class=\"token punctuation\">.</span>done <span class=\"token operator\">&amp;&amp;</span> fiber<span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">patch</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> op <span class=\"token operator\">=</span> patch<span class=\"token punctuation\">.</span>effectTag\n  <span class=\"token keyword\">const</span> tag <span class=\"token operator\">=</span> patch<span class=\"token punctuation\">.</span>tag\n\n  <span class=\"token comment\">// 行为删除标志 2</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>op <span class=\"token operator\">===</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 提交副作用 销毁的生命周期</span>\n    <span class=\"token comment\">// 行为 hook 1</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>tag <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> patch<span class=\"token punctuation\">.</span>return\n    <span class=\"token comment\">// 删除节点</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tag <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 行为 hook 1</span>\n    <span class=\"token comment\">// 提交副作用</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>op <span class=\"token operator\">===</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 行为 3 更新</span>\n    <span class=\"token comment\">// 更新dom上的属性 事件等</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// PLACEMENT</span>\n    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> <span class=\"token function\">getParentDomNode</span><span class=\"token punctuation\">(</span>patch<span class=\"token punctuation\">)</span>\n    node<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>patch<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  patch<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token constant\">NOWORK</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getParentDomNode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">patch</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> parentTag <span class=\"token operator\">=</span> patch<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">.</span>tag\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentTag <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> patch<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">.</span>stateNode\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentTag <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getParentDomNode</span><span class=\"token punctuation\">(</span>patch<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentTag <span class=\"token operator\">===</span> <span class=\"token constant\">HOSTROOT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> patch<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">.</span>dom\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>更新当前状态。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">HOST</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">updateHOST</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">HOSTROOT</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">updateHOSTROOT</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">HOOKCOMPONENT</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">updateHooks</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">CLASSCOMPONENT</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">updateClass</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// walk</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 已经遍历到根节点</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> <span class=\"token constant\">HOSTROOT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      preCommit <span class=\"token operator\">=</span> fiber\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n    fiber <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>return\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHOSTROOT</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">processUpdateQueue</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHOST</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> hostChildren <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span>\n\n  fiber<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> hostChildren\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHooks</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 当前WIP给到hooks</span>\n\n  currentHooksFiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n\n  fiber<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>type\n  fiber<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> Component\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateClass</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// link + diff</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n  <span class=\"token keyword\">let</span> oldChildren <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>oldChildren\n  <span class=\"token keyword\">let</span> newChildren <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>oldChildren <span class=\"token operator\">=</span> <span class=\"token function\">hashy</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> store <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// diff</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> k <span class=\"token keyword\">in</span> oldChildren<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> oldChildVnode <span class=\"token operator\">=</span> oldChildren<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">let</span> newChildVnode <span class=\"token operator\">=</span> newChildren<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\">// TODO 可判断key</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldChildVnode<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> newChildVnode<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      store<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newChildVnode\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> emptyFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Fiber</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      emptyFiber<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> fiber\n      emptyFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token constant\">DELETE</span>\n      commitQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>emptyFiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> prevFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token comment\">// diff</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> k <span class=\"token keyword\">in</span> newChildren<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> oldChildVnode <span class=\"token operator\">=</span> store<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">let</span> newChildVnode <span class=\"token operator\">=</span> newChildren<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\">// TODO 通过判断创建或复用alternate Fiber</span>\n    <span class=\"token comment\">// 这里应该是根据情况重新创建</span>\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Fiber</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChildVnode<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newFiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">=</span> <span class=\"token constant\">HOOKCOMPONENT</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      newFiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">=</span> <span class=\"token constant\">HOST</span>\n    <span class=\"token punctuation\">}</span>\n    newFiber<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> newChildVnode<span class=\"token punctuation\">.</span>type\n    newFiber<span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> newChildVnode<span class=\"token punctuation\">.</span>key\n    newFiber<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> newChildVnode<span class=\"token punctuation\">.</span>props\n    newFiber<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> fiber\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldChildVnode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token constant\">UPDATE</span>\n      newFiber<span class=\"token punctuation\">.</span>oldProps <span class=\"token operator\">=</span> oldChildVnode<span class=\"token punctuation\">.</span>props <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      commitQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newChildVnode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token constant\">PLACEMENT</span>\n      commitQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 链接链表</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      prevFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      fiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span>\n    prevFiber <span class=\"token operator\">=</span> newFiber\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevFiber<span class=\"token punctuation\">)</span> prevFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>定义 React 中根据 Fiber node 创建和更新元素的方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>type\n  <span class=\"token keyword\">let</span> dom\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    dom <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    dom<span class=\"token punctuation\">.</span>nodeValue <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>textValue\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    dom <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> dom\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dom<span class=\"token punctuation\">,</span> oldProps<span class=\"token punctuation\">,</span> newProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> name <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>oldProps<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>newProps <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> oldValue <span class=\"token operator\">=</span> oldProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">let</span> newValue <span class=\"token operator\">=</span> newProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldValue <span class=\"token operator\">===</span> newValue <span class=\"token operator\">||</span> name <span class=\"token operator\">===</span> <span class=\"token string\">'children'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'style'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 样式</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> k <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>oldValue<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>newValue <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>oldValue <span class=\"token operator\">&amp;&amp;</span> newValue <span class=\"token operator\">&amp;&amp;</span> oldValue<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> newValue<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>newValue <span class=\"token operator\">&amp;&amp;</span> newValue<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">startWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 事件</span>\n      name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldValue<span class=\"token punctuation\">)</span> dom<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> newValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newValue <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> newValue <span class=\"token operator\">===</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">removeAttribute</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> newValue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后可以重新定义 React 的 render 方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vnode<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 生成根节点</span>\n  <span class=\"token comment\">// 根节点标志 3</span>\n  <span class=\"token keyword\">const</span> FiberRootNode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FiberRoot</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Fiber</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  FiberRootNode<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> node\n  <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> node\n\n  current<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> FiberRootNode\n\n  <span class=\"token comment\">// 初始化调度工作</span>\n  <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>item<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>App<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>App<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>此时 Fiber reconciler 的基本调度算法已经实现，此时如果页面存在大量阻塞渲染时不会再干扰到页面其他动画的卡顿。</p>","timeToRead":5,"excerpt":"最近的 Group sharing 提到了 React16 中新引入的 Fiber reconciler 算法（区分之前的 Stack reconciler），深入浅出的梳理一番。 问题 大量的同步计算任务阻塞了浏览器的 UI 渲染。默认情况下，JS…","frontmatter":{"title":"Fiber reconciler","thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y5VUbUhTURg+26JfQb8F9Z5t9+7jujk/tmuZaGppGWZ+pGSoGKalpaLO/P6MpWJUgoFR9LNCsgwUpSxLMW2bUwkxzZWa5QdpJlpkcTvnuPzXpgcuz3uel/vwPO859wJgZ31McgefMlhSf6tlRBh/3Ja6rTVKl1au0gl4v3pdKlw2MGBbazJWQ/BrhVyIcaVO6rTeRE/z92T86g26G3N/HkgESNyx2Ii3FjwGQWAuV7nFzeXJe5HTXz8bGH7ZQLdj7ns9LUC1Y0GzmNt0GedOok6dURtm0lT850zl7EYJy8/lMhmYn9czImu03L6YCfoQHAvxJFHHIz11E1Eev63xmomFVA0/c041vVik2IN7sxdZgV2xHugP+ig/MCTWgrlmNeGG3bUDo8Fei+MRngtTcZ689ZQmFvMfTm+6Xyiwcygv4CGbS05ki540AvfxFlY3PObF8SMe2vlBRueEexaFTjCvl9mP2wGPAROlI/UbSisyQp9JJD5jorgvE9CXN1PcXdwzUpzA7MwBNFfHB9ILA4i7Xiog0Sz25weo/SYLcmmE3JJJwrmRBBQndCjUIM0ET+ER0EMdJIPugiF9aAQLaG99Kwnk+6FvJ+b7oJ+w3/UAsMh0/xerleWBGpketMHjROwJPCFvg+EbHTBs8BkMXTdJjvKvYCC5Ki9hsMg2Z8dxm8VxuzC2wJh09Ky3iiOH++hYHs12qIsKJUKdMAwYHYlhd3XIZatrFJnNLcnZO/dhvPUhPLn0CEZbW8Qx7KbzSNJ/Tfk6dlfL5Als6FLD6C03JemDTZLU99forCzMj7q4C5w178BzeBjFDrIvls9WgTJlCREsVZYylYqi7kpF8Vq1vHD1iizfA/OV8mIhj7Adhjt2hwWRCKmL2HKPYra8FAmnVCsKyWdQpSgkvUZpxvZ+VXImGeSo64jDbFWNU7bKIP7Xuyy/tPW91jM5YNsrwa2KvJimrvM+r67di+sSZRk5hAuaGiRcAAxM/jYdypIJqmQpu30VmeTGRij1hCtgKwAaAdjRwpFt6CSlE8ncaCZJgOLvSOcvuDsP7YSsLpgAAAAASUVORK5CYII=","width":150,"height":150,"src":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png","srcSet":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png 1x"}}},"slug":"fiber-reconciler","date":"2020-03-19T00:00:00.000Z","categories":["Algorithm","Popular"],"tags":["react","fiber"],"template":"post"},"fields":{"slug":"/fiber-reconciler/","date":"2020-03-19T00:00:00.000Z"}}},"pageContext":{"slug":"/fiber-reconciler/"}}}