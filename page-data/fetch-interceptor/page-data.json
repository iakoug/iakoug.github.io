{"componentChunkName":"component---src-templates-post-js","path":"/fetch-interceptor/","result":{"data":{"markdownRemark":{"html":"<p>封装自己的 fetch 请求库---拦截器篇</p>\n<hr>\n<p>关于 ajax 有非常多的封装库，最近两天自己简单封装了一下，好好体验其中三昧，内容不算太少，分为三篇说完。\n本篇博客的介绍内容是封装基于原生 fetch 的一个拦截器（interceptor）。\n请求库封装的源码在</p>\n<blockquote>\n<p><a href=\"https://github.com/justwink/obtain-fetch\">https://github.com/justwink/obtain-fetch</a></p>\n</blockquote>\n<h3 id=\"初始化请求基类\" style=\"position:relative;\"><a href=\"#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AF%B7%E6%B1%82%E5%9F%BA%E7%B1%BB\" aria-label=\"初始化请求基类 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>初始化请求基类</h3>\n<p>首先构造一个包含请求方法的基类，这样做方便随时向外暴露自己新增的接口</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Obtain</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">curl</span><span class=\"token punctuation\">(</span>url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> obtain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Obtain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> obtain<span class=\"token punctuation\">.</span>curl</code></pre></div>\n<p><em>这里使用原生的 fetch，关于兼容性封装 xmr 对象或者针对多端请求后面可以自行封装</em>\n基类 Obtain 拥有一个 curl 方法用来向外暴露发送异步请求</p>\n<h3 id=\"构造拦截器请求队列\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E9%80%A0%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%B7%E6%B1%82%E9%98%9F%E5%88%97\" aria-label=\"构造拦截器请求队列 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构造拦截器请求队列</h3>\n<p><em>参考 axios</em></p>\n<ul>\n<li>拦截器分为请求拦截器和响应拦截器</li>\n<li>在请求拦截器和响应拦截器之间我们将真正的请求发出</li>\n<li>请求拦截器的队列中对请求数据进行处理依次向下一个请求拦截器中传递直到触发真正请求</li>\n<li>真正的请求触发后需要将返回值作为当前的上下文传到接下来的响应拦截器的队列中</li>\n<li>依次执行响应拦截器队列中的回调对请求返回值进行处理</li>\n<li>以一条 promise 链将所有的中间处理过程连接起来</li>\n</ul>\n<h3 id=\"构造拦截器类\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E9%80%A0%E6%8B%A6%E6%88%AA%E5%99%A8%E7%B1%BB\" aria-label=\"构造拦截器类 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构造拦截器类</h3>\n<p>Interceptor 类拥有一个存储不同拦截器的队列 <code class=\"language-text\">handler</code>\n构造 use 方法将用户定义的拦截器 push 进拦截器队列\n构造 reducer 方法对拦截器队列中的拦截器函数进行批量处理</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Interceptor</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> handler<span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">>></span>\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token function\">use</span><span class=\"token punctuation\">(</span>success<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> failed<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handler<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>success<span class=\"token punctuation\">,</span> failed<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span>fn<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handler<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">handlerList</span> <span class=\"token operator\">=></span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>handlerList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Interceptor</code></pre></div>\n<h3 id=\"构造-fetch-类\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E9%80%A0-fetch-%E7%B1%BB\" aria-label=\"构造 fetch 类 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构造 Fetch 类</h3>\n<p>接受上面定义的拦截器进行初始化\n自身拥有 curl 方法对外暴露进行请求的派发，内部使用调用 fetch</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TypeInterceptor</span> <span class=\"token punctuation\">{</span>\n  request<span class=\"token operator\">:</span> Interceptor\n  response<span class=\"token operator\">:</span> Interceptor\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Fetch</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> interceptor<span class=\"token operator\">:</span> TypeInterceptor\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptor <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      request<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Interceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      response<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Interceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">curl</span><span class=\"token punctuation\">(</span>url<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Fetch</code></pre></div>\n<h3 id=\"构造-curl-方法\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E9%80%A0-curl-%E6%96%B9%E6%B3%95\" aria-label=\"构造 curl 方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构造 curl 方法</h3>\n<p>构造 curl 方法对拦截器队列进行初始化进行链式调用</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">curl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> any <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  options<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>method <span class=\"token operator\">||</span> <span class=\"token string\">'GET'</span>\n\n  <span class=\"token comment\">// 初始化promise</span>\n  <span class=\"token keyword\">let</span> promise <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 构造promise调用链</span>\n  <span class=\"token comment\">// 请求派发放在中间</span>\n  <span class=\"token keyword\">const</span> chain<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>Array<span class=\"token operator\">&lt;</span>Function <span class=\"token operator\">|</span> any<span class=\"token operator\">>></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\">// 将收集到的请求拦截器依次放在promise调用链中请求派发之前</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptor<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">handlerList</span> <span class=\"token operator\">=></span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span>handlerList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 将收集到的响应拦截器依次放在promise调用链中请求派发之后</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptor<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">handlerList</span> <span class=\"token operator\">=></span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>handlerList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// excute chain inteceptor</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    promise <span class=\"token operator\">=</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>chain<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> promise\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至此拦截器相关封装已经极为简单的完成了</p>\n<h3 id=\"对外暴露-curl-以及封装-use-方法便于使用\" style=\"position:relative;\"><a href=\"#%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2-curl-%E4%BB%A5%E5%8F%8A%E5%B0%81%E8%A3%85-use-%E6%96%B9%E6%B3%95%E4%BE%BF%E4%BA%8E%E4%BD%BF%E7%94%A8\" aria-label=\"对外暴露 curl 以及封装 use 方法便于使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>对外暴露 curl 以及封装 use 方法便于使用</h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> obtain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 使用简单的拦截器进行接口response的处理</span>\nobtain<span class=\"token punctuation\">.</span>interceptor<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> err<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">:</span> <span class=\"token string\">'oops, something wrong...'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// bind工具 对导出的curl上下文进行绑定</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">bind</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> curl<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fetch</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>curl<span class=\"token punctuation\">,</span> obtain<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 封装use方法 将fetch实例传递给外部传入的回调</span>\ncurl<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">use</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">plugin<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> plugin <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error: plugin must be a function!'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span>obtain<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> curl</code></pre></div>\n<h3 id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 拦截器</span>\nobtain<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">http</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  http<span class=\"token punctuation\">.</span>interceptor<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">option</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'in to interceptor ****************'</span><span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> option\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  http<span class=\"token punctuation\">.</span>interceptor<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">option</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'after interceptor ****************'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> option\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 并发</span>\nobtain<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">http</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  http<span class=\"token punctuation\">.</span>concurrency <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:4000/banner'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token string\">'result'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>End</p>","timeToRead":3,"excerpt":"封装自己的 fetch 请求库---拦截器篇 关于 ajax 有非常多的封装库，最近两天自己简单封装了一下，好好体验其中三昧，内容不算太少，分为三篇说完。\n本篇博客的介绍内容是封装基于原生 fetch 的一个拦截器（interceptor）。\n请求库封装的源码在 https…","frontmatter":{"title":"Fetch interceptor - 使用 ts 封装一个 fetch 请求库（拦截器篇）","thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y5VUbUhTURg+26JfQb8F9Z5t9+7jujk/tmuZaGppGWZ+pGSoGKalpaLO/P6MpWJUgoFR9LNCsgwUpSxLMW2bUwkxzZWa5QdpJlpkcTvnuPzXpgcuz3uel/vwPO859wJgZ31McgefMlhSf6tlRBh/3Ja6rTVKl1au0gl4v3pdKlw2MGBbazJWQ/BrhVyIcaVO6rTeRE/z92T86g26G3N/HkgESNyx2Ii3FjwGQWAuV7nFzeXJe5HTXz8bGH7ZQLdj7ns9LUC1Y0GzmNt0GedOok6dURtm0lT850zl7EYJy8/lMhmYn9czImu03L6YCfoQHAvxJFHHIz11E1Eev63xmomFVA0/c041vVik2IN7sxdZgV2xHugP+ig/MCTWgrlmNeGG3bUDo8Fei+MRngtTcZ689ZQmFvMfTm+6Xyiwcygv4CGbS05ki540AvfxFlY3PObF8SMe2vlBRueEexaFTjCvl9mP2wGPAROlI/UbSisyQp9JJD5jorgvE9CXN1PcXdwzUpzA7MwBNFfHB9ILA4i7Xiog0Sz25weo/SYLcmmE3JJJwrmRBBQndCjUIM0ET+ER0EMdJIPugiF9aAQLaG99Kwnk+6FvJ+b7oJ+w3/UAsMh0/xerleWBGpketMHjROwJPCFvg+EbHTBs8BkMXTdJjvKvYCC5Ki9hsMg2Z8dxm8VxuzC2wJh09Ky3iiOH++hYHs12qIsKJUKdMAwYHYlhd3XIZatrFJnNLcnZO/dhvPUhPLn0CEZbW8Qx7KbzSNJ/Tfk6dlfL5Als6FLD6C03JemDTZLU99forCzMj7q4C5w178BzeBjFDrIvls9WgTJlCREsVZYylYqi7kpF8Vq1vHD1iizfA/OV8mIhj7Adhjt2hwWRCKmL2HKPYra8FAmnVCsKyWdQpSgkvUZpxvZ+VXImGeSo64jDbFWNU7bKIP7Xuyy/tPW91jM5YNsrwa2KvJimrvM+r67di+sSZRk5hAuaGiRcAAxM/jYdypIJqmQpu30VmeTGRij1hCtgKwAaAdjRwpFt6CSlE8ncaCZJgOLvSOcvuDsP7YSsLpgAAAAASUVORK5CYII=","width":150,"height":150,"src":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png","srcSet":"/static/15b1871ea4c811121febad33ed4becb6/4148e/post.png 1x"}}},"slug":"fetch-interceptor","date":"2019-04-13T00:00:00.000Z","categories":["Encapsulating"],"tags":["typescript","fetch"],"template":"post"},"fields":{"slug":"/fetch-interceptor/","date":"2019-04-13T00:00:00.000Z"}}},"pageContext":{"slug":"/fetch-interceptor/"}}}