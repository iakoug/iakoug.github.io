---
date: 2019-10-08
title: Call function queue - ä¸‰ç§å‡½æ•°é˜Ÿåˆ—è°ƒç”¨é—®é¢˜çš„å½’æ¡£
template: post
thumbnail: '../thumbnails/algorithm.png'
slug: call-function-queue
categories:
  - Algorithm
  - Popular
tags:
  - interceptor
  - reduce
  - compose
  - functional
  - vue-router
  - redux
---

## å®ç° axios çš„æ‹¦æˆªå™¨

å¦‚ä½•å®ç° axios çš„æ‹¦æˆªå™¨å¬èµ·æ¥å¾ˆç©ºæ³›ï¼Œå¯ä»¥æ¢ä¸ªé—®æ³•ï¼šæœ‰è‹¥å¹²ä¸ªå‡½æ•°ï¼Œå¦‚ä½•ä¿è¯ä»–ä»¬å½¼æ­¤ä¾æ¬¡æŒ‰é¡ºåºè°ƒç”¨ï¼Ÿ
è¿™é‡Œå€ŸåŠ© Promise çš„é“¾å¼è°ƒç”¨çš„å°æŠ€å·§ï¼Œåˆ†åˆ«æŠŠæ¯ä¸€ä¸ªå‡½æ•°åŒ…è£…ä¸º Promise é“¾ä¸Šçš„æ¯ä¸€ä¸ªå›è°ƒã€‚

```js
// å‡½æ•°é˜Ÿåˆ—
const fns = []

// å€ŸåŠ© reduce
function generatePromiseChain(fns) {
  return fns.reduce((promises, fn) => {
    promises = promises.then(fn)

    return promises
  }, Promise.resolve())
}

// invoke execution
generatePromiseChain(fns).then(() => console.log('end'))
```

è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€æ¡æŒ‰é¡ºåºæ‰§è¡Œçš„ Promise é“¾ã€‚
è¿›è¡Œç®€å•æµ‹è¯•ï¼š

```js
const fns = [
  () => console.log('1'),
  () => console.log('2'),
  () => console.log('3')
]

generatePromiseChain(fns).then(() => console.log('end'))

// output:
// 1
// 2
// 3
// end
```

ä¸Šé¢å·²ç»å®ç°ä¸€æ¡æŒ‰åºè°ƒç”¨çš„å‡½æ•°é˜Ÿåˆ—äº†ï¼Œä½†æ˜¯å‡½æ•°çš„æ‰§è¡Œæ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„è€Œæ— æ³•ç”±ç”¨æˆ·ä¸»åŠ¨æ§åˆ¶ï¼Œé‚£ä¹ˆå¦‚ä½•æ§åˆ¶è¿™æ¡ Promise é“¾ï¼Œè®©æ¯æ¬¡çš„å‡½æ•°è°ƒç”¨ä¾èµ–ç”¨æˆ·çš„æ§åˆ¶å‘¢ï¼Ÿæ¢å¥è¯è¯´å°±æ˜¯æ¯ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨éœ€è¦ä¸€ä¸ªå¼€å…³ï¼Œå½“å¼€å…³æ‰“å¼€çš„æ—¶å€™æ‰å‘èµ·è°ƒç”¨ã€‚

## å®ç° vue-router çš„è·¯ç”±æ‹¦æˆª

è¿™é‡Œçš„å®ç°æ–¹å¼çš„å…³é”®åœ¨äºè¿™ä¸ªâ€œå¼€å…³â€ã€‚
æ—¢ç„¶å¼€å…³æ‰“å¼€æ˜¯æ‰å¼€å¯ä¸‹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼Œé‚£ä¹ˆå°±æŠŠå¼€å…³è®¾è®¡ä¸ºä¸€ä¸ªå‡½æ•°ï¼ŒæŠŠä¸‹ä¸€ä¸ªå‡½æ•°çš„çš„è°ƒç”¨åŒ…è£…åœ¨è¿™ä¸ªå¼€å…³å†…éƒ¨ï¼ˆç±»ä¼¼è£…é¥°è€…æ¨¡å¼ï¼‰å³å¯ï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒç”¨å¼€å…³è¿™ä¸ªå‡½æ•°å°±æ˜¯å¼€å¯ä¸‹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ã€‚
ä¸‹é¢å°è£…ä¸€ä¸ª compose å‡½æ•°ã€‚

```js
// æ„é€  compose å‡½æ•°
function compose(fns) {
  // åˆå§‹åŒ–è°ƒç”¨å‡½æ•°é˜Ÿåˆ— ä»ç¬¬ä¸€ä¸ªå¼€å§‹è‡ªè°ƒç”¨
  return void (function dispatch(order = 0) {
    // é˜Ÿåˆ—å­˜åœ¨å½“å‰é¡¹å‡½æ•°ä¾¿å‘èµ·è°ƒç”¨ åŒæ—¶åœ¨å½“å‰é¡¹å‡½æ•°å…¥å‚æ–°å¢å¼€å…³å›è°ƒå‡½æ•° å¼€å…³å†…éƒ¨åŒ…è£…ä¸‹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨
    return (
      fns[order] &&
      fns[order](function() {
        // å‡½æ•°é˜Ÿåˆ—ç´¢å¼•è‡ªåŠ 1è¿›è¡Œä¸‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨
        return dispatch(order + 1)
      })
    )
  })()
}
```

compose å·²ç»åŸºæœ¬å®Œæˆå°è£…ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```js
const fns = [
  next => console.log('1') || next(),
  next => console.log('2') || next(),
  () => console.log('end'),
  () => console.log('3')
]

compose(fns)

// ç”±äºå‡½æ•°é˜Ÿåˆ—çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ²¡æœ‰å¼€å¯ä¸‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„å¼€å…³ï¼Œæ‰€ä»¥è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

// output:
// 1
// 2
// end
```

ä¸Šé¢å·²ç»è¯´äº†å‡½æ•°é˜Ÿåˆ—è°ƒç”¨çš„ä¸¤ç§æ¨¡å¼ï¼š

- é“¾å¼åŒæ­¥è°ƒç”¨
- å¼€å…³å¼åŒæ­¥è°ƒç”¨

ä¸‹é¢å†ç»§ç»­è¯´è¯´ç¬¬ä¸‰ç§æ´‹è‘±æ¨¡å‹å¼å‡½æ•°é˜Ÿåˆ—è°ƒç”¨ï¼ˆç¬¬ä¸‰æ¬¡æåˆ°äº† ğŸ¤£ï¼Œä½†æ—¢ç„¶æ˜¯ç»Ÿä¸€å½’æ¡£ï¼Œé‚£ä¹ˆç²¾ç²¹çš„åŒç±»å‹å‡½æ•°é˜Ÿåˆ—çš„è°ƒç”¨å²‚èƒ½ä¸æ”¾åœ¨ä¸€èµ·ï¼‰

## å®ç° Koa2 æ´‹è‘±æ¨¡å‹

ç®€å•çš„æ¥è¯´æ´‹è‘±æ¨¡å‹å¼è°ƒç”¨å°±æ˜¯ç›¸å½“äºç»™æ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¢åŠ äº†ä¸€ä¸ªæ”¯æŒåç»­å¤„ç†çš„å®¹é”™æœºåˆ¶ï¼Œå±äºç”±å¤–å‘å†…è°ƒç”¨å¤„ç†ä¸€éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ï¼ˆæˆ–å‡ºç°é—®é¢˜æ—¶ï¼‰å†ç”±å†…å‘å¤–å¯ä»¥å¤„ç†åç»­é€»è¾‘çš„æœºåˆ¶ã€‚
å…·ä½“çš„ç»†èŠ‚å¾ˆç®€å•ä¸å†èµ˜è¿°ã€‚

```js
// æ„é€  compose å‡½æ•°ï¼ˆctx ä¸º Koa çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰
const compose = ctx => async middlewares =>
  // æ¥å—å‡½æ•°é˜Ÿåˆ—å€ŸåŠ© reduceRight æ–¹æ³•ç”±ç”±å‘å·¦è¿›è¡ŒåŒ…è£…ï¼ˆè¿™æ ·æ‰å¯ä»¥ä¿è¯æœ€å¤–å±‚å‡½æ•°æ˜¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæœ€å…ˆæ‰§è¡Œï¼‰
  await middlewares.reduceRight(
    (next, middleware) =>
      // ä»å³å‘å·¦å°†é˜Ÿåˆ—çš„æ¯ä¸ªå‡½æ•°åŒ…è£…ä¸ºä¸‹ä¸€ä¸ªå‡½æ•°çš„ next å¼€å…³
      (next = ((ctx, middleware, oldNext) => async () =>
        await middleware(ctx, oldNext))(ctx, middleware, next)),
    async () => Promise.resolve()
  )()
```

ä»¥ä¸Šä¾¿ç®€å•å°è£…å®Œæ¯•äº†ã€‚
ä¸‹é¢è¿›è¡Œæµ‹è¯•ï¼š

```js
const middlewares = [
  async (ctx, next) => {
    console.log(1)
    await next()
    console.log(2)
  },
  async (ctx, next) => {
    console.log(3)
    await next()
    console.log(4)
  },
  async (ctx, next) => {
    console.log(5)
    await next()
    console.log(6)
  }
]

compose(null)(middlewares)

// output:
// 1
// 3
// 5
// 6
// 4
// 2
```

## Last

ä»¥ä¸Šä¾¿æ˜¯æœ¬æ–‡å½’æ¡£çš„ä¸‰ç§å‡½æ•°é˜Ÿåˆ—ç®€å•è°ƒç”¨çš„æ¨¡å¼ï¼š

- é“¾å¼è°ƒç”¨
- å¼€å…³å¼è°ƒç”¨
- æ´‹è‘±æ¨¡å‹å¼è°ƒç”¨

The End.ğŸ†
